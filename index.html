<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>نئون‌ورس: تکامل نهایی</title>
    
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        :root {
            --bg: #030508;
            --panel: rgba(13, 17, 23, 0.9);
            --primary: #00f3ff;
            --secondary: #bd00ff;
            --accent: #ff003c;
            --success: #00ff9d;
            --text: #e2e8f0;
            --glass: 1px solid rgba(255,255,255,0.08);
            --font: 'Vazirmatn', sans-serif;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        
        body {
            margin: 0; background: var(--bg); color: var(--text); font-family: var(--font);
            height: 100dvh; overflow: hidden; display: flex; flex-direction: column;
        }

        /* --- Background & Effects --- */
        .cyber-bg {
            position: absolute; inset: 0; z-index: -1;
            background-image: 
                linear-gradient(rgba(0, 243, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(189, 0, 255, 0.03) 1px, transparent 1px);
            background-size: 40px 40px;
            mask-image: radial-gradient(circle at center, black 40%, transparent 100%);
        }
        .scanline {
            position: absolute; inset: 0; pointer-events: none; z-index: 0;
            background: linear-gradient(to bottom, transparent 50%, rgba(0,0,0,0.3) 51%);
            background-size: 100% 4px;
            opacity: 0.2;
        }

        /* --- Glitch Effect --- */
        .glitch { position: relative; display: inline-block; }
        .glitch::before, .glitch::after {
            content: attr(data-text); position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg);
        }
        .glitch::before { left: 2px; text-shadow: -1px 0 #ff003c; clip: rect(44px, 450px, 56px, 0); animation: glitch-anim 5s infinite linear alternate-reverse; }
        .glitch::after { left: -2px; text-shadow: -1px 0 #00f3ff; clip: rect(44px, 450px, 56px, 0); animation: glitch-anim2 5s infinite linear alternate-reverse; }
        @keyframes glitch-anim {
            0% { clip: rect(12px, 9999px, 32px, 0); } 20% { clip: rect(55px, 9999px, 88px, 0); }
            40% { clip: rect(22px, 9999px, 6px, 0); } 60% { clip: rect(15px, 9999px, 66px, 0); }
            80% { clip: rect(2px, 9999px, 81px, 0); } 100% { clip: rect(44px, 9999px, 12px, 0); }
        }
        @keyframes glitch-anim2 {
            0% { clip: rect(2px, 9999px, 81px, 0); } 20% { clip: rect(15px, 9999px, 66px, 0); }
            40% { clip: rect(22px, 9999px, 6px, 0); } 60% { clip: rect(55px, 9999px, 88px, 0); }
            80% { clip: rect(12px, 9999px, 32px, 0); } 100% { clip: rect(64px, 9999px, 12px, 0); }
        }

        /* --- Layout & UI --- */
        header {
            flex-shrink: 0; height: 60px; padding: 0 20px; display: flex; align-items: center; justify-content: space-between;
            background: rgba(3, 5, 8, 0.9); border-bottom: var(--glass); backdrop-filter: blur(10px); z-index: 50;
        }
        .brand { font-weight: 900; font-size: 20px; color: var(--primary); text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap: 10px; text-shadow: 0 0 15px var(--primary); }

        .btn {
            border: none; cursor: pointer; background: rgba(255,255,255,0.05); color: #fff;
            padding: 10px 16px; border-radius: 8px; font-family: var(--font); font-weight: 700;
            transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: var(--primary); color: #000; box-shadow: 0 0 15px rgba(0, 243, 255, 0.3); border: none; }
        .btn-danger { color: var(--accent); border-color: rgba(255,0,60,0.3); background: rgba(255,0,60,0.05); }

        /* --- Views --- */
        .view { position: absolute; inset: 0; opacity: 0; pointer-events: none; transition: 0.4s; transform: scale(0.95); display: flex; flex-direction: column; }
        .view.active { opacity: 1; pointer-events: auto; transform: scale(1); }

        /* --- Setup View --- */
        .setup-wrap {
            flex: 1; overflow-y: auto; padding: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-width: 1000px; margin: 0 auto; width: 100%;
        }
        @media (max-width: 768px) { .setup-wrap { grid-template-columns: 1fr; display: flex; flex-direction: column; } }

        .panel { background: var(--panel); border: var(--glass); border-radius: 20px; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        
        .toggle-row { display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.03); padding: 12px; border-radius: 10px; cursor: pointer; transition: 0.2s; }
        .toggle-row:hover { background: rgba(255,255,255,0.06); }
        
        .player-row { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .player-row:last-child { border-bottom: none; }

        /* --- Game View (Responsive) --- */
        .game-wrap {
            flex: 1; display: flex; flex-direction: row; height: calc(100% - 60px); overflow: hidden;
        }
        
        .sidebar {
            width: 280px; background: rgba(0,0,0,0.3); border-right: var(--glass);
            display: flex; flex-direction: column; transition: 0.3s; z-index: 10;
        }
        .log-area { flex: 1; overflow-y: auto; padding: 15px; font-family: monospace; font-size: 12px; display: flex; flex-direction: column; gap: 8px; }
        .log-entry { padding: 6px 10px; background: rgba(255,255,255,0.03); border-radius: 4px; border-right: 2px solid var(--primary); animation: fadeIn 0.3s; }
        
        .arena {
            flex: 1; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: radial-gradient(circle at center, rgba(0, 243, 255, 0.05) 0%, transparent 60%);
        }

        /* Wheel Canvas */
        .wheel-container {
            position: relative; width: 90vmin; height: 90vmin; max-width: 450px; max-height: 450px;
            filter: drop-shadow(0 0 40px rgba(189, 0, 255, 0.2));
        }
        canvas { width: 100%; height: 100%; border-radius: 50%; }
        
        .spin-btn {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 80px; height: 80px; border-radius: 50%;
            background: #fff; color: #000; font-weight: 900; border: 4px solid #000;
            font-size: 18px; box-shadow: 0 0 50px rgba(255,255,255,0.5);
            z-index: 20; cursor: pointer; transition: 0.2s;
        }
        .spin-btn:hover { transform: translate(-50%, -50%) scale(1.1); box-shadow: 0 0 70px rgba(255,255,255,0.8); }
        .spin-btn:active { transform: translate(-50%, -50%) scale(0.95); }

        /* Mobile Sidebar Handling */
        @media (max-width: 900px) {
            .game-wrap { flex-direction: column; }
            .sidebar { 
                width: 100%; height: auto; max-height: 0; overflow: hidden; border-right: none; border-top: var(--glass); position: absolute; bottom: 0; background: #0a0a0a;
            }
            .sidebar.open { max-height: 40vh; }
            
            .arena { padding-bottom: 60px; } /* Space for bottom bar */
            
            .mobile-controls {
                display: flex; justify-content: space-around; padding: 10px; background: rgba(0,0,0,0.8);
                position: absolute; bottom: 0; width: 100%; z-index: 30; border-top: var(--glass); backdrop-filter: blur(10px);
            }
        }
        
        /* --- Modal --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(15px); z-index: 100;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: 0.4s;
        }
        .modal-overlay.show { opacity: 1; pointer-events: auto; }
        
        .modal-card {
            width: 90%; max-width: 450px; background: #080a10; border: 1px solid var(--primary);
            border-radius: 24px; padding: 30px; text-align: center;
            transform: translateY(50px); transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 0 80px rgba(0, 243, 255, 0.1);
            position: relative; overflow: hidden;
        }
        .modal-overlay.show .modal-card { transform: translateY(0); }

        .mode-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .mode-card {
            height: 110px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px; display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.3s; gap: 8px;
        }
        .mode-card:hover { transform: translateY(-5px); }
        .mode-t:hover { border-color: var(--primary); background: rgba(0, 243, 255, 0.1); color: var(--primary); }
        .mode-d:hover { border-color: var(--secondary); background: rgba(189, 0, 255, 0.1); color: var(--secondary); }

        /* Auto Mode Timer Bar */
        .auto-timer {
            height: 4px; background: var(--accent); width: 0%; margin-top: 10px;
            transition: width 1s linear; opacity: 0;
        }
        .auto-timer.active { opacity: 1; }

        .hidden { display: none !important; }
        .hidden-mobile { display: block; }
        .visible-mobile { display: none; }
        @media(max-width:900px){ .hidden-mobile{display:none;} .visible-mobile{display:flex;} }

    </style>
</head>
<body>

    <div class="cyber-bg"></div>
    <div class="scanline"></div>

    <!-- HEADER -->
    <header>
        <div class="brand"><i data-lucide="aperture"></i> <span class="glitch" data-text="NeonVerse">NEONVERSE</span></div>
        <div style="display:flex; gap:10px; align-items:center;">
            <div id="autoBadge" class="hidden" style="font-size:10px; color:var(--accent); border:1px solid var(--accent); padding:2px 6px; border-radius:4px; animation: pulse 1s infinite;">AUTO MODE</div>
            <button id="toggleLog" class="btn btn-ghost visible-mobile"><i data-lucide="list"></i></button>
            <button id="resetApp" class="btn btn-danger" style="padding:8px;"><i data-lucide="trash-2" width="16"></i></button>
        </div>
    </header>

    <!-- SETUP VIEW -->
    <div id="viewSetup" class="view active">
        <div class="setup-wrap">
            <!-- Settings -->
            <div class="panel">
                <h3 style="margin:0; display:flex; align-items:center; gap:8px; color:var(--primary);"><i data-lucide="cpu"></i> هسته مرکزی</h3>
                
                <div class="toggle-row" onclick="el('checkAuto').click()">
                    <div>
                        <div style="font-weight:bold;">حالت آشوب (Auto Mode)</div>
                        <div style="font-size:11px; color:#888;">سیستم به صورت خودکار سرنوشت را انتخاب می‌کند.</div>
                    </div>
                    <input type="checkbox" id="checkAuto" style="accent-color:var(--accent); transform:scale(1.3);">
                </div>

                <hr style="border:0; border-top:1px solid rgba(255,255,255,0.1); width:100%;">

                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <label class="btn" style="flex-direction:column; font-size:12px; padding:15px; height:auto;">
                        <i data-lucide="file-text" style="color:var(--primary)"></i> 
                        <span>حقیقت (<span id="cntT">0</span>)</span>
                        <input type="file" hidden id="fileT" accept=".txt">
                    </label>
                    <label class="btn" style="flex-direction:column; font-size:12px; padding:15px; height:auto;">
                        <i data-lucide="zap" style="color:var(--secondary)"></i> 
                        <span>جرأت (<span id="cntD">0</span>)</span>
                        <input type="file" hidden id="fileD" accept=".txt">
                    </label>
                </div>
                <div style="font-size:10px; text-align:center; color:#555;">فایل txt (هر خط یک سوال) را انتخاب کنید</div>
            </div>

            <!-- Players -->
            <div class="panel" style="flex:1;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3 style="margin:0;">مسافران</h3>
                    <span id="pCount" style="background:var(--primary); color:#000; padding:2px 8px; border-radius:6px; font-size:12px; font-weight:bold;">0</span>
                </div>

                <div style="display:flex; gap:10px;">
                    <input type="text" id="inpName" placeholder="نام بازیکن..." style="flex:1; background:rgba(0,0,0,0.3); border:1px solid #444; padding:12px; border-radius:10px; color:#fff;">
                    <button id="btnAdd" class="btn btn-primary"><i data-lucide="plus"></i></button>
                </div>

                <div id="setupList" style="flex:1; overflow-y:auto; display:flex; flex-direction:column; gap:5px;">
                    <!-- Players injected here -->
                </div>

                <button id="btnStart" class="btn btn-primary" style="width:100%; padding:16px; font-size:18px; margin-top:10px;">
                    اجرای سیستم <i data-lucide="play"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- GAME VIEW -->
    <div id="viewGame" class="view">
        <div class="game-wrap">
            
            <!-- LOG SIDEBAR (Desktop: Left, Mobile: Bottom Sheet) -->
            <div class="sidebar" id="gameSidebar">
                <div style="padding:15px; border-bottom:var(--glass); display:flex; justify-content:space-between; align-items:center;">
                    <span style="font-size:12px; color:var(--primary); letter-spacing:1px;">SYSTEM LOG</span>
                    <span id="bagInfo" style="font-size:10px; padding:2px 6px; border:1px solid #444; border-radius:4px;">Fairness: 100%</span>
                </div>
                <div id="gameLog" class="log-area">
                    <div class="log-entry">سیستم آماده است...</div>
                </div>
            </div>

            <!-- ARENA -->
            <div class="arena">
                <button id="btnBack" class="btn" style="position:absolute; top:20px; right:20px; z-index:10; padding:8px 12px; font-size:12px;">خروج</button>
                
                <div class="wheel-container">
                    <canvas id="wheelCanvas" width="450" height="450"></canvas>
                    <button id="btnSpin" class="spin-btn">SPIN</button>
                    
                    <!-- Pointer -->
                    <svg style="position:absolute; top:-25px; left:50%; transform:translateX(-50%); width:50px; filter:drop-shadow(0 5px 5px rgba(0,0,0,0.8));" viewBox="0 0 50 50">
                        <path d="M25 50 L10 10 L40 10 Z" fill="#ff003c" stroke="#fff" stroke-width="3"/>
                    </svg>
                </div>
            </div>
        </div>
    </div>

    <!-- ACTION MODAL -->
    <div id="actionModal" class="modal-overlay">
        <div class="modal-card">
            <div style="font-size:12px; color:#888; letter-spacing:2px; margin-bottom:5px;">TARGET ACQUIRED</div>
            <h1 id="modalName" class="glitch" data-text="PLAYER" style="margin:0; font-size:40px; color:#fff;">PLAYER</h1>
            
            <div style="display:flex; justify-content:center; gap:15px; margin-top:10px; color:var(--primary); font-size:14px; font-family:monospace;">
                <span id="modalLvl">Lvl 1</span> | <span id="modalScore">0 PTS</span>
            </div>

            <!-- Phase 1: Selection -->
            <div id="phase1">
                <div class="mode-grid">
                    <div class="mode-card mode-t" onclick="Game.selectMode('t')">
                        <i data-lucide="file-text" size="32"></i> <strong>حقیقت</strong>
                    </div>
                    <div class="mode-card mode-d" onclick="Game.selectMode('d')">
                        <i data-lucide="zap" size="32"></i> <strong>جرأت</strong>
                    </div>
                </div>
                <!-- Auto Mode Visualizer -->
                <div id="autoBar" class="auto-timer"></div>
                <div id="autoText" class="hidden" style="font-size:10px; color:var(--accent); margin-top:5px; animation:pulse 0.5s infinite;">SYSTEM HACKING...</div>
            </div>

            <!-- Phase 2: Question -->
            <div id="phase2" class="hidden" style="margin-top:20px;">
                <div id="qText" style="min-height:120px; display:flex; align-items:center; justify-content:center; padding:20px; background:rgba(255,255,255,0.05); border-radius:16px; font-size:18px; line-height:1.6; border:1px dashed #555;">
                    Loading...
                </div>
                <div style="display:flex; gap:12px; margin-top:20px;">
                    <button class="btn btn-danger" onclick="Game.resolve(false)" style="flex:1;">انصراف</button>
                    <button class="btn btn-primary" onclick="Game.resolve(true)" style="flex:2;">انجام شد</button>
                </div>
            </div>
        </div>
    </div>

<script>
/* NEONVERSE CORE ENGINE v4.0 (Final) */
const AUDIO = new (window.AudioContext || window.webkitAudioContext)();
const COLORS = ['#00f3ff', '#bd00ff', '#ff003c', '#00ff9d', '#ffae00'];

// --- Utils ---
const el = id => document.getElementById(id);
const uid = () => Math.random().toString(36).substr(2, 8);

// --- Sound Engine ---
const SFX = {
    play(type) {
        if(AUDIO.state === 'suspended') AUDIO.resume();
        const o = AUDIO.createOscillator();
        const g = AUDIO.createGain();
        o.connect(g); g.connect(AUDIO.destination);
        const t = AUDIO.currentTime;

        if(type === 'tick') {
            o.type = 'triangle'; o.frequency.setValueAtTime(600, t);
            g.gain.setValueAtTime(0.02, t); g.gain.exponentialRampToValueAtTime(0.001, t+0.05);
            o.start(t); o.stop(t+0.05);
        } else if(type === 'win') {
            o.type = 'sine'; o.frequency.setValueAtTime(300, t); o.frequency.linearRampToValueAtTime(600, t+0.3);
            g.gain.setValueAtTime(0.1, t); g.gain.linearRampToValueAtTime(0, t+0.6);
            o.start(t); o.stop(t+0.6);
        } else if(type === 'auto') {
            o.type = 'sawtooth'; o.frequency.setValueAtTime(100, t); 
            g.gain.setValueAtTime(0.05, t); g.gain.linearRampToValueAtTime(0, t+0.2);
            o.start(t); o.stop(t+0.2);
        }
    }
};

// --- State ---
const State = {
    players: [], bag: [], qT: [], qD: [],
    settings: { auto: false }, active: null
};

// --- Wheel ---
const Wheel = {
    ctx: el('wheelCanvas').getContext('2d'),
    angle: 0, isSpinning: false,
    
    draw() {
        const ctx = this.ctx;
        const w = 450; const center = w/2; const len = State.players.length;
        ctx.clearRect(0,0,w,w);
        
        if(len === 0) return;
        const arc = (Math.PI*2) / len;
        const start = this.angle - (Math.PI/2); // Adjust 0 to top

        for(let i=0; i<len; i++) {
            const a = start + (i*arc);
            ctx.beginPath();
            ctx.moveTo(center, center);
            ctx.arc(center, center, center-10, a, a+arc);
            ctx.fillStyle = State.players[i].color + '44';
            ctx.fill();
            ctx.strokeStyle = State.players[i].color;
            ctx.lineWidth = 2;
            ctx.stroke();
            
            ctx.save();
            ctx.translate(center, center);
            ctx.rotate(a + arc/2);
            ctx.textAlign = "right";
            ctx.fillStyle = "#fff";
            ctx.font = "bold 18px Vazirmatn";
            ctx.shadowColor = "rgba(0,0,0,0.8)"; ctx.shadowBlur = 4;
            ctx.fillText(State.players[i].name, center-30, 6);
            ctx.restore();
        }
        
        // Center Cap
        ctx.beginPath(); ctx.arc(center, center, 50, 0, Math.PI*2);
        ctx.fillStyle = '#000'; ctx.fill();
        ctx.strokeStyle = '#fff'; ctx.lineWidth = 4; ctx.stroke();
    },

    spinTo(id) {
        if(this.isSpinning) return;
        this.isSpinning = true;
        el('btnSpin').style.display = 'none';
        
        const idx = State.players.findIndex(p => p.id === id);
        const len = State.players.length;
        const arc = (Math.PI*2) / len;
        
        // Calc target angle
        const spins = (Math.PI*2) * (5 + Math.random()*3); // 5-8 spins
        const segmentCenter = (idx * arc) + (arc/2);
        const targetAngle = (Math.PI*2) - segmentCenter - (Math.PI/2);
        
        const currentNorm = this.angle % (Math.PI*2);
        let delta = (targetAngle - currentNorm + (Math.PI*2)) % (Math.PI*2);
        delta += spins;

        const dur = 4500; const startT = performance.now(); const startA = this.angle;
        let lastTick = -1;
        const ease = t => 1 - Math.pow(1 - t, 3);

        const loop = (now) => {
            const p = Math.min((now - startT)/dur, 1);
            this.angle = startA + (delta * ease(p));
            this.draw();
            
            const totalRot = this.angle - startA;
            const ticks = Math.floor(totalRot / arc);
            if(ticks > lastTick) { SFX.play('tick'); lastTick = ticks; }

            if(p < 1) requestAnimationFrame(loop);
            else {
                this.isSpinning = false;
                el('btnSpin').style.display = 'block';
                Game.onWin();
            }
        };
        requestAnimationFrame(loop);
    }
};

// --- Logic ---
const Game = {
    add(name) {
        if(!name.trim()) return;
        State.players.push({
            id: uid(), name: name.trim(),
            score: 0, lvl: 1,
            color: COLORS[State.players.length % COLORS.length]
        });
        UI.update(); Storage.save(); Wheel.draw();
    },
    remove(id) {
        State.players = State.players.filter(p=>p.id!==id);
        UI.update(); Storage.save(); Wheel.draw();
    },
    getWinner() {
        State.bag = State.bag.filter(id => State.players.find(p=>p.id===id));
        if(State.bag.length === 0) {
            State.bag = State.players.map(p=>p.id).sort(()=>Math.random()-0.5);
            UI.log('سیستم عدالت ریست شد.');
        }
        const wid = State.bag.pop();
        el('bagInfo').innerText = `Fairness: ${Math.round((State.bag.length/State.players.length)*100)}%`;
        return wid;
    },
    spin() {
        if(State.players.length < 2) return alert('حداقل ۲ بازیکن!');
        const wid = this.getWinner();
        State.active = State.players.find(p=>p.id===wid);
        Wheel.spinTo(wid);
    },
    onWin() {
        SFX.play('win');
        confetti({ particleCount: 100, spread: 70, colors: [State.active.color, '#fff'] });
        UI.log(`انتخاب شد: ${State.active.name}`);
        
        // Update Modal UI
        el('modalName').innerText = State.active.name;
        el('modalName').setAttribute('data-text', State.active.name);
        el('modalName').style.color = State.active.color;
        el('modalLvl').innerText = `Lvl ${State.active.lvl}`;
        el('modalScore').innerText = `${State.active.score} PTS`;
        
        // Reset Phases
        el('phase1').classList.remove('hidden');
        el('phase2').classList.add('hidden');
        el('actionModal').classList.add('show');
        
        // Handle Auto Mode
        const bar = el('autoBar');
        const txt = el('autoText');
        if(State.settings.auto) {
            bar.style.width = '0%';
            bar.classList.add('active');
            txt.classList.remove('hidden');
            
            // Trigger animation
            setTimeout(() => { bar.style.width = '100%'; }, 50);
            
            // Exec
            setTimeout(() => {
                SFX.play('auto');
                this.selectMode(Math.random()>0.5 ? 't':'d');
                bar.classList.remove('active');
                bar.style.width = '0%';
                txt.classList.add('hidden');
            }, 2000); // 2s delay for drama
        } else {
            bar.classList.remove('active');
            txt.classList.add('hidden');
        }
    },
    selectMode(m) {
        const pool = m==='t' ? State.qT : State.qD;
        const txt = pool.length ? pool[Math.floor(Math.random()*pool.length)] : `(بانک خالی)\nیک سوال ${m==='t'?'حقیقت':'جرأت'} بپرسید.`;
        
        el('phase1').classList.add('hidden');
        el('phase2').classList.remove('hidden');
        
        const qt = el('qText');
        qt.innerText = txt;
        qt.style.borderColor = m==='t' ? 'var(--primary)' : 'var(--secondary)';
        qt.style.color = m==='t' ? 'var(--primary)' : 'var(--secondary)';
        
        UI.log(`${State.active.name}: ${m==='t'?'حقیقت':'جرأت'}`);
    },
    resolve(ok) {
        if(ok) {
            State.active.score += 10;
            if(State.active.score >= State.active.lvl * 50) {
                State.active.lvl++;
                UI.log(`لول آپ! ${State.active.name} -> Lvl ${State.active.lvl}`);
                SFX.play('win');
            }
        } else {
            State.active.score = Math.max(0, State.active.score - 5);
            UI.log(`${State.active.name} انصراف داد.`);
        }
        el('actionModal').classList.remove('show');
        Storage.save();
        UI.update();
    }
};

// --- UI ---
const UI = {
    update() {
        const l = el('setupList'); l.innerHTML = '';
        el('pCount').innerText = State.players.length;
        State.players.forEach(p => {
            const d = document.createElement('div');
            d.className = 'player-row';
            d.innerHTML = `<div style="font-weight:bold;color:${p.color}">${p.name}</div><button class="btn btn-danger" onclick="Game.remove('${p.id}')" style="padding:4px 8px;font-size:10px;">حذف</button>`;
            l.appendChild(d);
        });
    },
    log(msg) {
        const d = document.createElement('div');
        d.className = 'log-entry';
        const t = new Date().toTimeString().substr(0,5);
        d.innerHTML = `<span style="color:#666;font-size:10px;">${t}</span> ${msg}`;
        el('gameLog').prepend(d);
    }
};

// --- Storage ---
const Storage = {
    save() { localStorage.setItem('neonverse_v4', JSON.stringify({ p: State.players, s: State.settings, qt: State.qT, qd: State.qD })); this.cnt(); },
    load() {
        const d = JSON.parse(localStorage.getItem('neonverse_v4'));
        if(d) {
            State.players = d.p||[]; State.settings = d.s||{auto:false};
            State.qT = d.qt||[]; State.qD = d.qd||[];
            el('checkAuto').checked = State.settings.auto;
            el('autoBadge').classList.toggle('hidden', !State.settings.auto);
            UI.update(); Wheel.draw(); this.cnt();
        }
    },
    cnt() { el('cntT').innerText = State.qT.length; el('cntD').innerText = State.qD.length; },
    read(inp, type) {
        const f = inp.files[0]; if(!f)return;
        const r = new FileReader();
        r.onload = e => {
            const l = e.target.result.split(/\r?\n/).filter(x=>x.trim().length>1);
            if(type==='t') State.qT.push(...l); else State.qD.push(...l);
            alert(`اضافه شد: ${l.length}`); this.save();
        };
        r.readAsText(f);
    }
};

// --- Init ---
window.onload = () => {
    Storage.load();
    el('btnAdd').onclick = () => { const i = el('inpName'); Game.add(i.value); i.value=''; };
    el('btnStart').onclick = () => { el('viewSetup').classList.remove('active'); el('viewGame').classList.add('active'); Wheel.draw(); };
    el('btnBack').onclick = () => { el('viewGame').classList.remove('active'); el('viewSetup').classList.add('active'); };
    el('btnSpin').onclick = () => Game.spin();
    el('resetApp').onclick = () => { if(confirm('پاکسازی؟')) { localStorage.clear(); location.reload(); } };
    
    el('checkAuto').onchange = e => { 
        State.settings.auto = e.target.checked; 
        el('autoBadge').classList.toggle('hidden', !State.settings.auto);
        Storage.save(); 
    };
    el('fileT').onchange = e => Storage.read(e.target, 't');
    el('fileD').onchange = e => Storage.read(e.target, 'd');
    el('toggleLog').onclick = () => el('gameSidebar').classList.toggle('open');
    
    window.onresize = () => Wheel.draw();
};
</script>
</body>
</html>
